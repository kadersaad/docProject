<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decider Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Decider Analysis {{ prefill_decideur_id }}</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="back-link">Back to Home</a>
            </nav>
        </header>

        <form method="POST" action="{{ url_for('decideur_page') }}">
            <div class="form-group" hidden>
                <label for="decideur_id">Choose a decider (1, 2, 3 or 4):</label>
                <input type="number" id="decideur_id" name="decideur_id" min="1" max="4" value="{{ prefill_decideur_id }}" required>
            </div>

            <h3>Decider Parameters (editable):</h3>
            <div class="form-group">
                <label for="poids_input">Weights (comma-separated, e.g.: 4.96,7.08,17.31,...):</label>
                <input type="text" id="poids_input" name="poids_input" value="{{ prefill_poids_str }}" required>
            </div>
            <div class="form-group">
                <label for="seuil_p_input">Preference thresholds (p) (comma-separated):</label>
                <input type="text" id="seuil_p_input" name="seuil_p_input" value="{{ prefill_seuil_p_str }}" required>
            </div>
            <div class="form-group">
                <label for="seuil_q_input">Indifference thresholds (q) (comma-separated):</label>
                <input type="text" id="seuil_q_input" name="seuil_q_input" value="{{ prefill_seuil_q_str }}" required>
            </div>

            <div class="form-group" hidden>
                <label for="new_data_matrix">Enter the new Data Matrix (CSV-like) or leave empty to use 'nearest_points_to_centroids.csv':</label>
                <textarea id="new_data_matrix" name="new_data_matrix" rows="10" placeholder="Ex:&#10;1,10,20,5,80,4,0.3,15&#10;2,12,22,6,85,5,0.4,18&#10;3,8,18,4,75,3,0.2,12"></textarea>
                <small>Expected format (if filled): ID_ZONE, NUISANCES, BRUIT, IMPACTS, GEOTECHNIQ, EQUIPEMENT, ACCESSIBIL, CLIMAT. (No header)</small>
                <small>If empty, the file 'nearest_points_to_centroids.csv' (generated by Negotiator Analysis) will be used as the input matrix for SWOT calculation.</small>
            </div>

            <button type="submit">Run Analysis</button>
        </form>

        {% if error %}
            <div class="error-message">
                <p>Error: {{ error }}</p>
            </div>
        {% endif %}

        
        {% if results %}
            <div class="results">
                <h2>Decider Analysis Results {{ results.decideur_id }}</h2>
                <h3>Parameters Used:</h3>
                <pre>Weights: {{ results.decideur_params.poids }}</pre>
                <pre>Preference thresholds (p): {{ results.decideur_params.seuil_p }}</pre>
                <pre>Indifference thresholds (q): {{ results.decideur_params.seuil_q }}</pre>

                <h3>Processed Data Matrix:</h3>
                {% if results.sub_matrix_processed %}
                    <table>
                        <thead>
                            <tr>
                                {% for key in results.sub_matrix_processed[0].keys() %}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results.sub_matrix_processed %}
                            <tr>
                                {% for value in row.values() %}
                                    <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No processed data matrix to display (it may have been empty or could not be loaded).</p>
                {% endif %}
                
                <h3>Preference Matrix (C_P):</h3>
                {% if results.preference_matrix %}
                    <table>
                        <thead>
                            <tr>
                                {% for key in results.preference_matrix[0].keys() %}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results.preference_matrix %}
                            <tr>
                                {% for value in row.values() %}
                                    <td>{{ value | round(4) if value is number else value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No preference matrix to display.</p>
                {% endif %}

                <h3>Discordance Matrix (C_D):</h3>
                {% if results.discordance_matrix %}
                    <table>
                        <thead>
                            <tr>
                                {% for key in results.discordance_matrix[0].keys() %}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results.discordance_matrix %}
                            <tr>
                                {% for value in row.values() %}
                                    <td>{{ value | round(4) if value is number else value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No discordance matrix to display.</p>
                {% endif %}

                <h3>PROMETHEE II Ranking:</h3>
                {% if results.ranking_table %}
                <div class="table-container">
                    {{ results.ranking_table | safe }}
                </div>
                {% else %}
                    <p>No PROMETHEE II ranking generated or found. Check logs for ranking generation errors.</p>
                {% endif %}

                <h3>Final Decision (PROMETHEE II & SWOT):</h3>
                {% if results.final_decision_data %}
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                {% for key in results.final_decision_data[0].keys() %}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results.final_decision_data %}
                            <tr {% if row.Decision == 'Denied' %}style="background-color: #ffcccc;"{% endif %}>
                                {% for value in row.values() %}
                                    <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No final decision table to display.</p>
                {% endif %}

                <h3>SWOT Plot:</h3>
                {% if results.swot_plot_url %}
                    <img src="{{ results.swot_plot_url }}" alt="SWOT Plot" class="swot-plot">
                {% else %}
                    <p>No SWOT plot generated or found. Check logs for plot generation errors.</p>
                {% endif %}
            </div>
        {% endif %}
        
    </div>
</body>
</html>
